## 概述





## 内部网络协议 RIP







## 内部网络协议 OSPF

### 介绍

Open Shortest Path First

**开放最短路径优先 OSPF 协议**：“开放”标明 OSPF 协议不是受某一家厂商控制，而是**公开发表**的.

“最短路径优先”是因为使用了 **Dijkstra** 提出的**最短路径算法 SPF**。

OSPF 最主要的特征就是使用**分布式的链路状态协议**。

### 特点

- 和谁交换 

  **使用洪泛法向自治系统内所有路由器发送信息**，即路由器通过输出端口向所有相邻的路由器发送信思，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。

  **等同广播,最终整个区域内所有路由器都得到了这个信息的一个副本**

- 交换什么

  发送的信息就是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，以及该链路的度量/代价ーー费用、距离、时延、带宽等）。

- 多久交换

  只有当链路状态发生变化时，路由器才向所有路由器洪泛发送此信息。

最后，**所有路由器都能建立一个链路状态数据库，即全网拓扑图**。

### 链路状态路由算法

1. 每个路由器发现它的邻居结点,发送HELLO 问候分组，并了解邻居节点的网络地址。

2. 设置到它的每个邻居的成本度量 metric

3. 构造`DD 数据库描述分组`，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。

4. 如果 DD 分组中的摘要自己都有，则邻站不做处理：如果有没有的或者是更新的，则发送`LSR 链路状态请求分组`请求自己没有的和比自己更新的信息。

5. 收到邻站的 LSR 分组后，发送`LSU 链路状态更新分组`进行更新 

6. 更新完毕后，邻站返回一个`LSAck 链路状态确认分组`进行确认。

只要一个路由器的链路状态发生变化：

5. 泛洪发送`LSU 链路状态更新分组`进行更新。

7. 更新完毕后，其他站返回一个`LSAck 链路状态确认分组`进行确认。

8. 使用 Dijkstra 根据自己的链路状态数据库构造到其他节点间的最短路径。



### OSPF的区域

为了使 OSPF能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域。

每一个区域都有一个 32 位的区域标识符(用点分十进制表示),区域也不能太大，在一个区域内的路由器最好不超过 200 个。

![image-20190922170455651](assets/路由算法与路由协议/image-20190922170455651.png)



主干区域:0.0.0.0。联通其他区域

- 主干路由器

​      主干区域中的路由器都叫做主干路由器

- 边界路由器

​      R3和R7既是主干路由器,也是区域边界路由器.

- 自治系统外界路由器

  连接其他自治系统

-   区域内部路由器

  区域内的路由器叫做区域内部路由器.





### OSPF分组

<img src="assets/路由算法与路由协议/image-20190922170959253.png" alt="image-20190922170959253" style="zoom:50%;" />





**OSPF 直接用 IP 数据报传送,可以看成网络层的协议。RIP协议使用UDP,某种程度上可以说是用户层的协议.**

### OSPF其他特点

1. 每隔 **30 min**，要刷新一次数据库中的链路状态。

2. 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。**因此当互联网规模很大时，OSPF 协议要比距离向量协议 RIP 好得多。**

3. **OSPF 不存在坏消息传的慢的问题，它的收敛速度很快**。

   根据信息更新全局拓扑





## 外部网络协议BGP

v4

### 特点

![image-20190922171621101](assets/路由算法与路由协议/image-20190922171621101.png)

- 和谁交换？

​     与其他 AS 的邻站 BGP 发言人交换信息。

- 交换什么？

  交换的网络可达性的信息，即要到达某个网络所要经过的一系列 AS。

- 多久交换？

  发生变化时更新有变化的部分

### BGP 协议交换信息的过程

**BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS**。当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各 AS 的较好路由。

<img src="assets/路由算法与路由协议/image-20190922171930470.png" alt="image-20190922171930470" style="zoom:50%;" />

BGP 发言人交换路径向量

自治系统 AS2 的 BGP 发言人通知主干网 AS1 的 BGP 发言人：“要到达网络 N1、N2、N3 和 N4 可经过 AS2。”

![image-20190922171947405](assets/路由算法与路由协议/image-20190922171947405.png)

BGP 发言人交换路径向量

主干网还可发出通知：“要到达网络 N5、N6 和 N7 可沿路径（AS1, AS3)。

![image-20190922172143704](assets/路由算法与路由协议/image-20190922172143704.png)



### BGP的报文格式

一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要**先建立 TCP 连接，即通过 TCP 传送**，然后在此连接上交换 BGP 报文以建立 **BGP 会话（session）**，利用 BGP 会话交换路由信息。

<img src="assets/路由算法与路由协议/image-20190922172323704.png" alt="image-20190922172323704" style="zoom:50%;" />



**BGP 是应用层协议，借助 TCP 传送。**

### BGP协议特点

BGP 支持 **CIDR**，因此 BGP 的路由表也就应当包括**目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列**。

在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但**以后只需要在发生变化时更新有变化的部分**。这样做对节省网络带宽和减少路由器的处理开销都有好处。

### BGP-4的四种报文

1.OPEN（打开）报文：用来与相邻的另一个 BGP 发言人建立关系，并认证发送方。

2.UPDATE（更新）报文：通告新路径或撤销原路径。

3.KEEPALIVE（保活）报文：在无 UPDATE时，周期性证实邻站的连通性；也作为 OPEN 的确认。

4. NOTIFICATION（通知）报文：报告先前报文的差错：也被用于关闭连接。



## 三种协议对比

`RIP` 是一种**分布式的基于距离向量**的**内部网关路由选择协议**，通过**广播 UDP 报文**来交换路由信息。

`OSPF `是一个**内部网关协议**，要交换的信息量较大，应使报文的长度尽量短，所以不使用传输层协议（如 UDP 或 TCP），而是直接采用**IP**。

`BGP` 是一个**外部网关协议**，在不同的自治系统之间交换路由信息，**由于网络环境复杂，需要保证可靠传输，所以用 TCP**



![image-20190922173019866](assets/路由算法与路由协议/image-20190922173019866.png)



![image-20190922173135757](assets/路由算法与路由协议/image-20190922173135757.png)









